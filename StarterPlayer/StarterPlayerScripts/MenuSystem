local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local combatEvent = ReplicatedStorage:WaitForChild("CombatEvent")

-- ==============================================================================
-- [ë°ì´í„° ì„¤ì •]
-- ==============================================================================
local myStats = {
	Level = 1,
	Gold = 200,
	Attack = 10,
	Health = 100,
	Defense = 5
}

-- ì•„ì´í…œ ëª©ë¡ (ì´ˆê¸° ë°ì´í„°)
local inventoryData = {
	{ id = 1, name = "Iron Sword", type = "Weapon", stat = "ATK +5", value = 5, icon = "âš”ï¸" },
	{ id = 2, name = "Wood Shield", type = "Shield", stat = "DEF +3", value = 3, icon = "ğŸ›¡ï¸" },
	{ id = 3, name = "Leather Armor", type = "Body", stat = "HP +20", value = 20, icon = "ğŸ‘•" },
	{ id = 4, name = "Iron Helm", type = "Head", stat = "HP +10", value = 10, icon = "ğŸª–" },
	{ id = 5, name = "Speed Boots", type = "Shoes", stat = "SPD +2", value = 2, icon = "ğŸ‘¢" },
	{ id = 6, name = "Fire Ball", type = "Special", stat = "SPC +10", value = 10, icon = "ğŸ”¥" },
    { id = 7, name = "Potion", type = "Consumable", stat = "HP +50", value = 50, icon = "ğŸ§ª" },
    -- í…ŒìŠ¤íŠ¸ìš© ì¤‘ë³µ ì•„ì´í…œ
    { id = 8, name = "Potion", type = "Consumable", stat = "HP +50", value = 50, icon = "ğŸ§ª" },
    { id = 9, name = "Red Brick", type = "Material", stat = "ì¬ë£Œ", value = 0, icon = "ğŸ§±" },
    { id = 10, name = "Red Brick", type = "Material", stat = "ì¬ë£Œ", value = 0, icon = "ğŸ§±" },
}

-- í˜„ì¬ ì¥ì°©ëœ ì•„ì´í…œ
local equippedData = {
	Head = nil,
	Weapon = nil,
	Body = nil,
	Shield = nil,
	Shoes = nil,
	Special = nil
}

-- í˜„ì¬ ì„ íƒëœ íƒ­ ("Equip" | "Stat" | "Material")
local currentTab = "Equip" 

-- ==============================================================================
-- [UI ìƒì„±]
-- ==============================================================================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GameMenuUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- 1. ë©”ë‰´ ë²„íŠ¼
local menuButton = Instance.new("TextButton")
menuButton.Name = "MenuButton"
menuButton.Size = UDim2.new(0.08, 0, 0.1, 0) 
menuButton.Position = UDim2.new(0.02, 0, 0.5, 0) 
menuButton.AnchorPoint = Vector2.new(0, 0.5) 
menuButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
menuButton.Text = "MENU"
menuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
menuButton.Font = Enum.Font.GothamBold
menuButton.TextScaled = true 
menuButton.Parent = screenGui

local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0.2, 0) 
btnCorner.Parent = menuButton

local btnAspect = Instance.new("UIAspectRatioConstraint")
btnAspect.AspectRatio = 1 
btnAspect.Parent = menuButton

local btnStroke = Instance.new("UIStroke")
btnStroke.Thickness = 2
btnStroke.Color = Color3.fromRGB(255, 255, 255)
btnStroke.Parent = menuButton

-- 2. ë©”ì¸ í”„ë ˆì„
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0.6, 0, 0.6, 0) 
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5) 
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.Visible = false 
mainFrame.Parent = screenGui

local mainAspect = Instance.new("UIAspectRatioConstraint")
mainAspect.AspectRatio = 1.55
mainAspect.Parent = mainFrame

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0.03, 0)
mainCorner.Parent = mainFrame

local mainStroke = Instance.new("UIStroke")
mainStroke.Thickness = 3
mainStroke.Color = Color3.fromRGB(0, 0, 0)
mainStroke.Parent = mainFrame

local dragDetector = Instance.new("UIDragDetector")
dragDetector.Parent = mainFrame

-- 2-1. ì¸ë²¤í† ë¦¬ ì„¹ì…˜ (ì™¼ìª½)
local invSection = Instance.new("Frame")
invSection.Name = "InventorySection"
invSection.Size = UDim2.new(0.55, 0, 0.85, 0) 
invSection.Position = UDim2.new(0.03, 0, 0.05, 0)
invSection.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
invSection.Parent = mainFrame

local invCorner = Instance.new("UICorner")
invCorner.CornerRadius = UDim.new(0.02, 0)
invCorner.Parent = invSection

local invGrid = Instance.new("ScrollingFrame")
invGrid.Size = UDim2.new(0.95, 0, 0.95, 0)
invGrid.Position = UDim2.new(0.025, 0, 0.025, 0)
invGrid.BackgroundTransparency = 1
invGrid.ScrollBarThickness = 6
invGrid.AutomaticCanvasSize = Enum.AutomaticSize.Y
invGrid.CanvasSize = UDim2.new(0, 0, 0, 0) 
invGrid.Parent = invSection

local gridLayout = Instance.new("UIGridLayout")
gridLayout.Parent = invGrid

-- ê·¸ë¦¬ë“œ í¬ê¸° ìë™ ì¡°ì ˆ
local function updateGrid()
	local gridWidth = invGrid.AbsoluteSize.X
	if gridWidth <= 0 then return end
	local sizePx = gridWidth * 0.18
	local paddingPx = gridWidth * 0.015
	gridLayout.CellSize = UDim2.new(0, sizePx, 0, sizePx)
	gridLayout.CellPadding = UDim2.new(0, paddingPx, 0, paddingPx)
end
invGrid:GetPropertyChangedSignal("AbsoluteSize"):Connect(updateGrid)

-- 2-2. ì¥ë¹„ & ìŠ¤íƒ¯ ì„¹ì…˜ (ì˜¤ë¥¸ìª½)
local equipSection = Instance.new("Frame")
equipSection.Name = "EquipSection"
equipSection.Size = UDim2.new(0.38, 0, 0.7, 0) 
equipSection.Position = UDim2.new(0.6, 0, 0.05, 0)
equipSection.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
equipSection.Parent = mainFrame

local equipCorner = Instance.new("UICorner")
equipCorner.CornerRadius = UDim.new(0.02, 0)
equipCorner.Parent = equipSection

local slotSize = UDim2.new(0.25, 0, 0.25, 0) 
local slots = {
    {Name="Head", Pos=UDim2.new(0.5, 0, 0.12, 0), Icon="ğŸª–"},
    {Name="Weapon", Pos=UDim2.new(0.2, 0, 0.42, 0), Icon="âš”ï¸"},
    {Name="Body", Pos=UDim2.new(0.5, 0, 0.42, 0), Icon="ğŸ‘•"},
    {Name="Shield", Pos=UDim2.new(0.8, 0, 0.42, 0), Icon="ğŸ›¡ï¸"},
    {Name="Shoes", Pos=UDim2.new(0.35, 0, 0.72, 0), Icon="ğŸ‘¢"},
    {Name="Special", Pos=UDim2.new(0.65, 0, 0.72, 0), Icon="âœ¨"},
}

local equipButtons = {} 
for _, s in ipairs(slots) do
    local slotBtn = Instance.new("TextButton")
    slotBtn.Name = s.Name
    slotBtn.Size = slotSize
    slotBtn.Position = s.Pos
    slotBtn.AnchorPoint = Vector2.new(0.5, 0) 
    slotBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    slotBtn.Text = s.Icon .. "\n" .. s.Name
    slotBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    slotBtn.Font = Enum.Font.GothamBold
    slotBtn.TextScaled = true 
    slotBtn.Parent = equipSection
    
    local sc = Instance.new("UICorner")
    sc.CornerRadius = UDim.new(0.2, 0)
    sc.Parent = slotBtn
    
    local aspect = Instance.new("UIAspectRatioConstraint")
    aspect.AspectRatio = 1
    aspect.Parent = slotBtn
    
    equipButtons[s.Name] = slotBtn
end

-- 2-3. ë ˆë²¨ & ê³¨ë“œ (ì˜¤ë¥¸ìª½ í•˜ë‹¨)
local statFrame = Instance.new("Frame")
statFrame.Size = UDim2.new(0.38, 0, 0.1, 0)
statFrame.Position = UDim2.new(0.6, 0, 0.76, 0)
statFrame.BackgroundTransparency = 1
statFrame.Parent = mainFrame

local lvlLabel = Instance.new("TextLabel")
lvlLabel.Size = UDim2.new(0.5, 0, 1, 0)
lvlLabel.BackgroundTransparency = 1
lvlLabel.Text = "Lv. 1" 
lvlLabel.TextColor3 = Color3.fromRGB(100, 200, 255) 
lvlLabel.Font = Enum.Font.GothamBold
lvlLabel.TextScaled = true
lvlLabel.TextXAlignment = Enum.TextXAlignment.Left
lvlLabel.Parent = statFrame

local goldLabel = Instance.new("TextLabel")
goldLabel.Size = UDim2.new(0.5, 0, 1, 0)
goldLabel.Position = UDim2.new(0.5, 0, 0, 0)
goldLabel.BackgroundTransparency = 1
goldLabel.Text = "G: 0" 
goldLabel.TextColor3 = Color3.fromRGB(255, 220, 0) 
goldLabel.Font = Enum.Font.GothamBold
goldLabel.TextScaled = true
goldLabel.TextXAlignment = Enum.TextXAlignment.Right
goldLabel.Parent = statFrame

-- [ì¶”ê°€ë¨] ìŠ¤íƒ¯ ìƒì„¸ ì •ë³´ì°½ (ìŠ¤íƒ¯ íƒ­ ëˆ„ë¥¼ ë•Œ ë³´ì„)
local detailStatFrame = Instance.new("Frame")
detailStatFrame.Name = "DetailStatFrame"
detailStatFrame.Size = UDim2.new(0.55, 0, 0.85, 0) -- ì¸ë²¤í† ë¦¬ ìë¦¬ì— í‘œì‹œ
detailStatFrame.Position = UDim2.new(0.03, 0, 0.05, 0)
detailStatFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
detailStatFrame.Visible = false
detailStatFrame.Parent = mainFrame

local dStatCorner = Instance.new("UICorner")
dStatCorner.CornerRadius = UDim.new(0.02, 0)
dStatCorner.Parent = detailStatFrame

local detailText = Instance.new("TextLabel")
detailText.Size = UDim2.new(0.9, 0, 0.9, 0)
detailText.Position = UDim2.new(0.05, 0, 0.05, 0)
detailText.BackgroundTransparency = 1
detailText.TextColor3 = Color3.new(1,1,1)
detailText.Font = Enum.Font.GothamBold
detailText.TextScaled = true
detailText.TextXAlignment = Enum.TextXAlignment.Left
detailText.TextYAlignment = Enum.TextYAlignment.Top
detailText.Text = "STATS INFO..."
detailText.Parent = detailStatFrame

-- 2-4. íƒ­ ë²„íŠ¼ ì„¹ì…˜ (ìˆ˜ì •ë¨)
local tabFrame = Instance.new("Frame")
tabFrame.Size = UDim2.new(0.38, 0, 0.08, 0)
tabFrame.Position = UDim2.new(0.6, 0, 0.88, 0)
tabFrame.BackgroundTransparency = 1
tabFrame.Parent = mainFrame

-- íƒ­ ì„¤ì •: ì¥ì‹ êµ¬(Equip), ìŠ¤íƒ¯(Stat), ì¬ë£Œ(Material)
local tabData = {
	{id="Equip", name="ì¥ì‹ êµ¬"},
	{id="Stat", name="ìŠ¤íƒ¯"},
	{id="Material", name="ì¬ë£Œ"}
}
local tabButtons = {}

-- íƒ­ ì „í™˜ ë° í™”ë©´ ê°±ì‹  í•¨ìˆ˜ (ì„ ì–¸ë§Œ, êµ¬í˜„ì€ ì•„ë˜ì—)
local refreshUI

for i, t in ipairs(tabData) do
    local tabBtn = Instance.new("TextButton")
    tabBtn.Name = t.id
    tabBtn.Size = UDim2.new(0.3, 0, 1, 0)
    tabBtn.Position = UDim2.new(0.35 * (i-1), 0, 0, 0)
    tabBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    tabBtn.Text = t.name
    tabBtn.TextColor3 = Color3.new(1,1,1)
    tabBtn.Font = Enum.Font.Gotham
    tabBtn.TextScaled = true
    tabBtn.Parent = tabFrame
    
    local tc = Instance.new("UICorner")
    tc.CornerRadius = UDim.new(0.3, 0)
    tc.Parent = tabBtn
	
	-- íƒ­ í´ë¦­ ì´ë²¤íŠ¸
	tabBtn.MouseButton1Click:Connect(function()
		currentTab = t.id
		refreshUI() -- í™”ë©´ ê°±ì‹ 
	end)
	
	tabButtons[t.id] = tabBtn
end

-- ==============================================================================
-- [ê¸°ëŠ¥ êµ¬í˜„]
-- ==============================================================================

local function refreshStats()
	lvlLabel.Text = "Lv. " .. myStats.Level
	goldLabel.Text = "G: " .. myStats.Gold
	
	-- ìƒì„¸ ìŠ¤íƒ¯ì°½ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
	detailText.Text = string.format(
		"ğŸ“Š PLAYER STATS\n\nâš”ï¸ Attack: %d\nğŸ›¡ï¸ Defense: %d\nâ¤ï¸ Max HP: %d\nğŸ’° Gold: %d\nâœ¨ Level: %d",
		myStats.Attack, myStats.Defense, myStats.Health, myStats.Gold, myStats.Level
	)
end

function refreshEquipment()
    for slotName, btn in pairs(equipButtons) do
        local item = equippedData[slotName]
        if item then
            btn.Text = item.icon .. "\n" .. item.name .. "\n(" .. item.stat .. ")"
            btn.BackgroundColor3 = Color3.fromRGB(100, 150, 255) 
        else
            local defaultIcon = ""
            for _, s in ipairs(slots) do 
                if s.Name == slotName then defaultIcon = s.Icon end 
            end
            btn.Text = defaultIcon .. "\n" .. slotName
            btn.BackgroundColor3 = Color3.fromRGB(80, 80, 80) 
        end
    end
end

-- [í•µì‹¬] ì¸ë²¤í† ë¦¬ ê°±ì‹  (íƒ­ í•„í„°ë§ + ì¤‘ë³µ ê²¹ì¹˜ê¸° ì ìš©)
local function refreshInventory()
    -- ê¸°ì¡´ ì•„ì´í…œ UI ì‚­ì œ
    for _, child in pairs(invGrid:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    
	-- 1. ì•„ì´í…œ ê·¸ë£¹í™” (ì´ë¦„ ê¸°ì¤€ìœ¼ë¡œ ê°œìˆ˜ ì„¸ê¸°)
	local groupedItems = {} -- { "Iron Sword": {count=1, item=data}, ... }
	local displayList = {}  -- ìˆœì„œ ìœ ì§€ë¥¼ ìœ„í•œ ë¦¬ìŠ¤íŠ¸
	
	for _, item in ipairs(inventoryData) do
		-- íƒ­ í•„í„°ë§ ë¡œì§
		local showItem = false
		if currentTab == "Equip" then
			-- ì¥ì‹ êµ¬ íƒ­: ì¬ë£Œê°€ ì•„ë‹Œ ê²ƒë“¤ (ì¥ë¹„ + ì†Œë¹„í…œ)
			if item.type ~= "Material" then showItem = true end
		elseif currentTab == "Material" then
			-- ì¬ë£Œ íƒ­: ì¬ë£Œë§Œ
			if item.type == "Material" then showItem = true end
		end
		
		if showItem then
			if not groupedItems[item.name] then
				-- ìƒˆë¡œìš´ ì•„ì´í…œ ë°œê²¬
				local entry = { count = 1, data = item }
				groupedItems[item.name] = entry
				table.insert(displayList, entry)
			else
				-- ì´ë¯¸ ìˆëŠ” ì•„ì´í…œ -> ê°œìˆ˜ ì¦ê°€
				groupedItems[item.name].count = groupedItems[item.name].count + 1
			end
		end
	end
    
    -- 2. ê·¸ë£¹í™”ëœ ì•„ì´í…œ í‘œì‹œ
    for _, entry in ipairs(displayList) do
		local item = entry.data
		local count = entry.count
		
        local itemBtn = Instance.new("TextButton")
        itemBtn.Name = item.name
        itemBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
        itemBtn.Text = item.icon
        itemBtn.TextScaled = true 
        itemBtn.Parent = invGrid
        
        local ic = Instance.new("UICorner"); ic.Parent = itemBtn
        
        -- ì´ë¦„ í‘œì‹œ
        local nameLbl = Instance.new("TextLabel")
        nameLbl.Size = UDim2.new(1,0,0.3,0)
        nameLbl.Position = UDim2.new(0,0,0.7,0)
        nameLbl.BackgroundTransparency = 1
        nameLbl.Text = item.name
        nameLbl.TextColor3 = Color3.new(1,1,1)
        nameLbl.TextScaled = true
        nameLbl.Parent = itemBtn
		
		-- [ì¶”ê°€ë¨] ìˆ˜ëŸ‰ í‘œì‹œ (x2, x3...)
		if count > 1 then
			local countLbl = Instance.new("TextLabel")
			countLbl.Size = UDim2.new(0.4, 0, 0.4, 0)
			countLbl.Position = UDim2.new(1, -2, 1, -2) -- ì˜¤ë¥¸ìª½ ì•„ë˜
			countLbl.AnchorPoint = Vector2.new(1, 1)
			countLbl.BackgroundTransparency = 1
			countLbl.Text = "x" .. count
			countLbl.TextColor3 = Color3.fromRGB(255, 255, 0) -- ë…¸ë€ìƒ‰
			countLbl.TextStrokeTransparency = 0 -- í…Œë‘ë¦¬ ì¶”ê°€í•´ì„œ ì˜ ë³´ì´ê²Œ
			countLbl.Font = Enum.Font.GothamBlack
			countLbl.TextScaled = true
			countLbl.Parent = itemBtn
		end
        
        -- í´ë¦­ ì´ë²¤íŠ¸ (ì¥ì°©)
        itemBtn.MouseButton1Click:Connect(function()
            if item.type == "Material" then
                print("â›” ì¬ë£Œ ì•„ì´í…œì€ ì¥ì°©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return
            end

            local slotType = item.type
            if equippedData[slotType] == nil then
				-- ì‹¤ì œ ì¸ë²¤í† ë¦¬ ë°°ì—´ì—ì„œ í•´ë‹¹ ì•„ì´í…œì„ ì°¾ì•„ í•˜ë‚˜ë§Œ ì œê±°
				for idx, v in ipairs(inventoryData) do
					if v.name == item.name then
						table.remove(inventoryData, idx)
						break
					end
				end
				
				-- ì¥ì°©
                equippedData[slotType] = item
                print("Equipped: " .. item.name)
				
                refreshUI() -- ì „ì²´ ê°±ì‹ 
            else
                print("âš ï¸ ì´ë¯¸ ì¥ì°©ëœ ì•„ì´í…œì´ ìˆìŠµë‹ˆë‹¤! ë¨¼ì € ì¥ë¹„ë¥¼ í•´ì œí•˜ì„¸ìš”.")
            end
        end)
    end
end

-- í†µí•© UI ê°±ì‹  í•¨ìˆ˜
refreshUI = function()
	-- íƒ­ ë²„íŠ¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
	for id, btn in pairs(tabButtons) do
		if id == currentTab then
			btn.BackgroundColor3 = Color3.fromRGB(100, 100, 100) -- ì„ íƒë¨ (ë°ê²Œ)
		else
			btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60) -- ì„ íƒ ì•ˆë¨ (ì–´ë‘¡ê²Œ)
		end
	end
	
	-- ì„¹ì…˜ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
	if currentTab == "Stat" then
		invSection.Visible = false
		detailStatFrame.Visible = true
	else
		invSection.Visible = true
		detailStatFrame.Visible = false
		refreshInventory() -- ì¸ë²¤í† ë¦¬ ë‚´ìš© ê°±ì‹  (í•„í„°ë§ ì ìš©)
	end
	
	refreshEquipment()
	refreshStats()
end

-- ì¥ë¹„ í•´ì œ ë¡œì§
for slotName, btn in pairs(equipButtons) do
    btn.MouseButton1Click:Connect(function()
        local item = equippedData[slotName]
        if item then
            equippedData[slotName] = nil
            table.insert(inventoryData, item) 
            
            print("Unequipped: " .. item.name)
            refreshUI()
        end
    end)
end

menuButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
    if mainFrame.Visible then 
        task.wait(0.01) 
        updateGrid() 
		refreshUI()
    end
end)

combatEvent.OnClientEvent:Connect(function(action, data)
	if action == "Reward" then
		if data.gold then
			myStats.Gold = myStats.Gold + data.gold
		end
		if data.items then
			for _, newItemData in ipairs(data.items) do
				table.insert(inventoryData, {
					id = os.time(),
					name = newItemData.name,
					type = newItemData.type,
					stat = newItemData.stat,
					value = 0,
					icon = newItemData.icon
				})
			end
		end
		refreshUI()
	end
end)

-- ì´ˆê¸° ì‹¤í–‰
updateGrid()
refreshUI()

print("âœ… ë©”ë‰´ ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ (ìŠ¤íƒ/íƒ­ ê¸°ëŠ¥)")
