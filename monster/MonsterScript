local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local combatEvent = ReplicatedStorage:WaitForChild("CombatEvent")
local monster = script.Parent
local isBattleActive = false 

-- ==============================================================================
-- [설정] 
-- ==============================================================================
local MONSTER_CONFIG = {
	name = "Red Cube",
	maxHP = 20,
	atk = 5,
	def = 1,
	maxSP = 3,      
	startSP = 1,    
	spRegen = 1,    
	respawnTime = 5 
}

local SKILL_CONFIG = {
	ATK = {cost = 1}, 
	BLK = {cost = 1}, 
	SPC = {cost = 2, minTurn = 2, cooldown = 2}
}

local PLAYER_SKILL_CONFIG = {
	SPC = {cost = 2, minTurn = 2, cooldown = 2}
}

-- 플레이어 스탯 (임시)
local PLAYER_STATS = {
	maxHP = 40,
	currentHP = 40,
	atk = 8,
	def = 2
}

local battleState = {} 

--------------------------------------------------------------------------------
-- 기본 기능들 (리스폰, 이동 등)
--------------------------------------------------------------------------------
local function respawnMonster()
	monster.Transparency = 1
	monster.CanCollide = false
	monster.Anchored = true
	task.wait(MONSTER_CONFIG.respawnTime)
	monster.Transparency = 0
	monster.CanCollide = true
	monster.Color = Color3.fromRGB(255, 0, 0)
	isBattleActive = false 
	print("♻️ 몬스터 리스폰")
end

local function repositionPlayer(character)
	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if rootPart then
		local direction = (rootPart.Position - monster.Position).Unit
		local newPos = monster.Position + (direction * 15)
		rootPart.CFrame = CFrame.new(newPos, monster.Position)
	end
end

local function freezePlayer(character, freeze)
	local humanoid = character:FindFirstChild("Humanoid")
	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if humanoid and rootPart then
		if freeze then
			humanoid.WalkSpeed = 0
			humanoid.JumpPower = 0
			rootPart.Anchored = true
		else
			humanoid.WalkSpeed = 35 
			humanoid.JumpPower = 60
			rootPart.Anchored = false
		end
	end
end

local function generateMonsterActions(userId)
	local state = battleState[userId]
	if not state then return {} end

	local mState = state.monsterStats
	local currentSP = mState.currentSP
	local currentTurn = state.turnCount
	local nextSpecialTurn = state.monsterNextSpecialTurn

	local pattern = {}
	local actions = {"ATK", "BLK"} 
	
	-- 시뮬레이션용 임시 SP (패턴 생성 중에만 씀)
	local simSP = currentSP

	for i = 1, mState.maxSP do
		local chosenAction = "-" 

		if currentTurn >= SKILL_CONFIG.SPC.minTurn and 
			currentTurn >= nextSpecialTurn and 
			simSP >= SKILL_CONFIG.SPC.cost then

			chosenAction = "SPC"
			simSP = simSP - SKILL_CONFIG.SPC.cost
			state.monsterNextSpecialTurn = currentTurn + SKILL_CONFIG.SPC.cooldown + 1

		elseif simSP >= SKILL_CONFIG.ATK.cost then
			local randomPick = actions[math.random(1, #actions)]
			chosenAction = randomPick
			simSP = simSP - SKILL_CONFIG[randomPick].cost
		else
			chosenAction = "-"
		end
		table.insert(pattern, chosenAction)
	end
	return pattern
end

--------------------------------------------------------------------------------
-- [핵심 수정] 턴 판정 및 '로그' 생성
--------------------------------------------------------------------------------
local function resolveTurn(player, playerActions)
	local state = battleState[player.UserId]
	if not state then return end

	local pStats = state.playerStats
	local mStats = state.monsterStats
	local mActions = state.monsterActions
	local currentTurn = state.turnCount

	-- 이번 턴에 일어난 일을 기록할 장부 (Log)
	local turnLog = {}

	local maxSlots = math.max(#playerActions, #mActions)

	for i = 1, maxSlots do
		local pAct = playerActions[i] or "-"
		local mAct = mActions[i] or "-"

		-- 1. 몬스터 코스트 지불
		local mCost = SKILL_CONFIG[mAct] and SKILL_CONFIG[mAct].cost or 0
		if mStats.currentSP >= mCost then
			mStats.currentSP = mStats.currentSP - mCost
		else
			mAct = "-" 
		end

		-- 2. 플레이어 쿨타임 체크
		if pAct == "SPC" then
			if currentTurn >= PLAYER_SKILL_CONFIG.SPC.minTurn and 
				currentTurn >= state.playerNextSpecialTurn then
				state.playerNextSpecialTurn = currentTurn + PLAYER_SKILL_CONFIG.SPC.cooldown + 1
			else
				pAct = "-" 
			end
		end
		
		-- 데미지 계산
		local pDamageTaken = 0
		local mDamageTaken = 0

		-- 몬스터 공격 -> 플레이어
		if mAct == "ATK" or mAct == "SPC" then
			local dmg = mStats.atk
			if mAct == "SPC" then dmg = dmg * 1.5 end 
			if pAct == "BLK" then dmg = math.max(0, dmg - (pStats.def + 5))
			else dmg = math.max(0, dmg - pStats.def) end
			pDamageTaken = dmg
		end

		-- 플레이어 공격 -> 몬스터
		if pAct == "ATK" or pAct == "SPC" then
			local dmg = pStats.atk
			if pAct == "SPC" then dmg = dmg * 2 end 
			if mAct == "BLK" then dmg = math.max(0, dmg - (mStats.def + 5))
			else dmg = math.max(0, dmg - mStats.def) end
			mDamageTaken = dmg
		end

		-- 실제 HP 적용
		pStats.currentHP = math.max(0, pStats.currentHP - pDamageTaken)
		mStats.currentHP = math.max(0, mStats.currentHP - mDamageTaken)

		-- [중요] 이 슬롯에서 일어난 일을 기록해서 저장!
		table.insert(turnLog, {
			slot = i,
			pAction = pAct,
			mAction = mAct,
			pDmg = pDamageTaken,
			mDmg = mDamageTaken
		})
	end

	-- 턴 종료 처리
	state.turnCount = state.turnCount + 1
	mStats.currentSP = mStats.currentSP + MONSTER_CONFIG.spRegen 

	-- 다음 턴 패턴 미리 생성
	local nextMonsterActions = generateMonsterActions(player.UserId)
	state.monsterActions = nextMonsterActions

	-- 클라이언트에게 보낼 데이터 패키지
	local resultData = {
		turnLog = turnLog, -- 상세 기록 (애니메이션용)
		
		-- 최종 결과 (애니메이션 끝난 후 보정용)
		finalPHP = pStats.currentHP, 
		finalMHP = mStats.currentHP,
		pMax = pStats.maxHP,
		mMax = mStats.maxHP,
		
		nextPattern = nextMonsterActions,
		gameResult = nil -- "WIN", "LOSE", or nil
	}

	if pStats.currentHP <= 0 then resultData.gameResult = "LOSE" end
	if mStats.currentHP <= 0 then resultData.gameResult = "WIN" end

	-- "ShowResult" 라는 새로운 신호로 보냄
	combatEvent:FireClient(player, "ShowResult", resultData)

	-- 게임 끝났으면 정리 (메모리만 정리, 실제 종료 신호는 EndBattle 이벤트에서 처리)
	if resultData.gameResult then
		battleState[player.UserId] = nil
		if resultData.gameResult == "WIN" then 
			respawnMonster() 
		else
			-- [수정] 패배 시에도 전투 상태를 풀어줘야 다시 싸울 수 있음
			isBattleActive = false 
		end
	end
end

--------------------------------------------------------------------------------
-- 이벤트 연결
--------------------------------------------------------------------------------
combatEvent.OnServerEvent:Connect(function(player, action, data)
	if action == "SubmitActions" then
		resolveTurn(player, data)
	-- [추가됨] 클라이언트가 결과 애니메이션을 다 봤다고 신호 보냄
	elseif action == "EndBattle" then
		freezePlayer(player.Character, false) -- 플레이어 움직임 봉인 해제
		combatEvent:FireClient(player, "End") -- 카메라 복구 명령
	end
end)

monster.Touched:Connect(function(hit)
	if isBattleActive then return end
	local character = hit.Parent
	local player = Players:GetPlayerFromCharacter(character)

	if player then
		isBattleActive = true
		repositionPlayer(character)
		freezePlayer(character, true)

		-- 초기 상태 설정
		local initialActions = generateMonsterActions(player.UserId) 
		-- generateMonsterActions 내부 로직상 state가 필요하므로 순서 조정 필요하지만,
		-- 여기선 간단히 먼저 state 만들고 호출
		
		battleState[player.UserId] = {
			turnCount = 1,          
			monsterNextSpecialTurn = 0,
			playerNextSpecialTurn = 0,
			playerStats = { maxHP=PLAYER_STATS.maxHP, currentHP=PLAYER_STATS.currentHP, atk=PLAYER_STATS.atk, def=PLAYER_STATS.def },
			monsterStats = { maxHP=MONSTER_CONFIG.maxHP, currentHP=MONSTER_CONFIG.maxHP, atk=MONSTER_CONFIG.atk, def=MONSTER_CONFIG.def, maxSP=MONSTER_CONFIG.maxSP, currentSP=MONSTER_CONFIG.startSP },
			monsterActions = {}
		}
		
		-- 진짜 패턴 생성
		initialActions = generateMonsterActions(player.UserId)
		battleState[player.UserId].monsterActions = initialActions

		local startData = {
			monsterName = MONSTER_CONFIG.name,
			monsterMaxSP = MONSTER_CONFIG.maxSP,
			monsterActions = initialActions,
			playerStats = PLAYER_STATS,
			monsterStats = battleState[player.UserId].monsterStats
		}
		combatEvent:FireClient(player, "Start", startData)
	end
end)
